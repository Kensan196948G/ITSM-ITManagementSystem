#!/bin/bash

# GitHubè‡ªå‹•åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# å®šæœŸçš„ãªPush/Pullç”¨

set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«åœæ­¢

REPO_URL="https://github.com/Kensan196948G/ITSM-ITManagementSystem.git"
BRANCH="main"
LOG_FILE="logs/git-sync.log"

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p logs

# ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "ğŸ”„ Starting Git Auto-Sync..."

# Gitè¨­å®šç¢ºèª
if [ ! -d ".git" ]; then
    log "âŒ Not a git repository. Initializing..."
    git init
    git remote add origin "$REPO_URL"
fi

# ãƒªãƒ¢ãƒ¼ãƒˆç¢ºèª
if ! git remote get-url origin > /dev/null 2>&1; then
    git remote add origin "$REPO_URL"
    log "âœ… Added remote origin: $REPO_URL"
fi

# ãƒ–ãƒ©ãƒ³ãƒç¢ºèªãƒ»ä½œæˆ
current_branch=$(git branch --show-current 2>/dev/null || echo "")
if [ -z "$current_branch" ]; then
    log "ğŸ“ Creating initial branch: $BRANCH"
    git checkout -b "$BRANCH"
fi

# æœ€åˆã®Pullï¼ˆãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆï¼‰
log "ğŸ“¥ Pulling latest changes from remote..."
if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
    git pull origin "$BRANCH" --allow-unrelated-histories || {
        log "âš ï¸  Pull failed, continuing with local changes..."
    }
else
    log "ğŸ“ Remote branch $BRANCH doesn't exist yet. Will create on first push."
fi

# å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ -z "$(git status --porcelain)" ]; then
    log "âœ… No changes to commit"
else
    log "ğŸ“ Changes detected, committing..."
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
    git add .
    
    # ã‚³ãƒŸãƒƒãƒˆï¼ˆè‡ªå‹•ç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
    commit_message="Auto-sync: $(date '+%Y-%m-%d %H:%M:%S') - ITSM Development Progress

ğŸ¤– Generated by Claude-Flow Auto-Sync

Changes:
$(git diff --cached --name-status | head -20)

ğŸš€ Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
    
    git commit -m "$commit_message"
    log "âœ… Changes committed"
fi

# Push
log "ğŸ“¤ Pushing to GitHub..."
if git push origin "$BRANCH"; then
    log "âœ… Successfully pushed to GitHub"
else
    log "âŒ Push failed. You may need to set up authentication."
    log "ğŸ’¡ Tip: Use 'gh auth login' or set up Personal Access Token"
    exit 1
fi

log "ğŸ‰ Git Auto-Sync completed successfully!"